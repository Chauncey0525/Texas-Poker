<!--pages/rooms/game/game.wxml-->
<view class="container">
  <block wx:if="{{gameState && gameState.gamePhase !== 'waiting'}}">
    <!-- æ¸¸æˆä¿¡æ¯æ  -->
    <view class="game-header">
      <view class="room-info">
        <text class="room-name">{{room.roomName}}</text>
        <text class="hand-number">ç¬¬ {{gameState.handNumber || 1}} å±€</text>
      </view>
      <view class="game-stats">
        <text>åº•æ± : {{gameState.pot}}</text>
        <text>å½“å‰ä¸‹æ³¨: {{gameState.currentBet}}</text>
      </view>
      <view class="game-phase">
        <text>{{gameState.gamePhase === 'preflop' ? 'ç¿»ç‰Œå‰' : gameState.gamePhase === 'flop' ? 'ç¿»ç‰Œ' : gameState.gamePhase === 'turn' ? 'è½¬ç‰Œ' : gameState.gamePhase === 'river' ? 'æ²³ç‰Œ' : 'ç­‰å¾…ä¸­'}}</text>
      </view>
    </view>

    <!-- ç©å®¶åˆ—è¡¨ç»„ä»¶ -->
    <player-list
      players="{{gameState.players}}"
      currentPlayerIndex="{{gameState.currentPlayerIndex}}"
      myPlayerIndex="{{myPlayerIndex}}"
      gamePhase="{{gameState.gamePhase}}"
      layout="circle"
      bind:playertap="onPlayerTap"
    />

    <!-- å…¬å…±ç‰Œ -->
    <view class="community-cards-section">
      <view class="section-title">å…¬å…±ç‰Œ</view>
      <view class="community-cards">
        <view class="card-item" wx:for="{{gameState.communityCards}}" wx:key="index">
          <text class="card-suit">{{item.suit}}</text>
          <text class="card-rank">{{item.rank}}</text>
        </view>
        <view wx:if="{{gameState.communityCards.length === 0}}" class="no-cards">ç­‰å¾…å‘ç‰Œ</view>
      </view>
    </view>

    <!-- æ“ä½œæç¤º -->
    <view class="action-hint" wx:if="{{gameState.currentPlayerIndex >= 0}}">
      <view class="hint-content">
        <text class="hint-text">
          <text wx:if="{{isMyTurn}}" class="hint-highlight">è½®åˆ°æ‚¨è¡ŒåŠ¨äº†ï¼</text>
          <text wx:else>ç­‰å¾… {{gameState.players[gameState.currentPlayerIndex].name}} è¡ŒåŠ¨...</text>
        </text>
        <view class="timer-display" wx:if="{{isMyTurn && timeLeft > 0}}">
          <text class="timer-text">å‰©ä½™æ—¶é—´: </text>
          <text class="timer-value {{timeLeft <= 10 ? 'warning' : ''}}">{{timeLeft}}ç§’</text>
        </view>
      </view>
    </view>

    <!-- è§‚æˆ˜æç¤º -->
    <view wx:if="{{isSpectator && gameState.gamePhase !== 'ended'}}" class="spectator-notice">
      <view class="spectator-content">
        <text class="spectator-icon">ğŸ‘ï¸</text>
        <text class="spectator-text">è§‚æˆ˜æ¨¡å¼ - æ‚¨å·²å‡ºå±€ï¼Œå¯ä»¥è§‚çœ‹å…¶ä»–ç©å®¶æ¸¸æˆ</text>
      </view>
    </view>

    <!-- æ“ä½œåŒºåŸŸï¼ˆä»…å½“å‰ç©å®¶æ˜¾ç¤ºï¼‰ -->
    <view wx:if="{{isMyTurn && !isSpectator}}" class="action-panel">
      <view class="action-buttons">
        <button 
          class="btn btn-check" 
          bindtap="onCheck" 
          wx:if="{{gameState.currentBet === 0}}"
        >
          è¿‡ç‰Œ
        </button>
        <button 
          class="btn btn-call" 
          bindtap="onCall" 
          wx:if="{{gameState.currentBet > 0}}"
        >
          è·Ÿæ³¨ {{gameState.currentBet - (gameState.players[myPlayerIndex].currentBet || 0)}}
        </button>
        <button class="btn btn-bet" bindtap="showBetInput">ä¸‹æ³¨</button>
        <button class="btn btn-raise" bindtap="showRaiseInput">åŠ æ³¨</button>
        <button class="btn btn-fold" bindtap="onFold">å¼ƒç‰Œ</button>
        <button class="btn btn-allin" bindtap="onAllIn">å…¨æŠ¼</button>
      </view>
    </view>

    <!-- ä¸‹æ³¨è¾“å…¥ç»„ä»¶ -->
    <bet-input
      wx:if="{{showBetInput}}"
      currentBet="{{gameState.currentBet}}"
      playerChips="{{gameState.players[myPlayerIndex].chips}}"
      minBet="{{minBetAmount}}"
      bind:confirm="onBet"
    />
    
    <!-- åŠ æ³¨è¾“å…¥ç»„ä»¶ -->
    <bet-input
      wx:if="{{showRaiseInput}}"
      currentBet="{{gameState.currentBet}}"
      playerChips="{{gameState.players[myPlayerIndex].chips}}"
      minBet="{{minRaiseAmount}}"
      bind:confirm="onRaise"
    />

    <!-- èŠå¤©åŒºåŸŸ -->
    <view class="chat-panel">
      <scroll-view class="chat-messages" scroll-y scroll-top="{{chatScrollTop}}">
        <view class="chat-message" wx:for="{{chatMessages}}" wx:key="index">
          <text class="chat-nickname">{{item.nickname}}:</text>
          <text class="chat-content">{{item.message}}</text>
        </view>
      </scroll-view>
      <view class="chat-input-area">
        <input 
          class="chat-input"
          type="text"
          placeholder="è¾“å…¥æ¶ˆæ¯..."
          value="{{chatInput}}"
          bindinput="onChatInput"
        />
        <button class="chat-send-btn" bindtap="onSendChat">å‘é€</button>
      </view>
    </view>

    <!-- ç¦»å¼€æŒ‰é’® -->
    <view class="leave-btn-container">
      <button class="btn-leave" bindtap="onLeaveGame">ç¦»å¼€æ¸¸æˆ</button>
    </view>
  </block>

  <!-- ç­‰å¾…æ¸¸æˆå¼€å§‹ -->
  <view wx:else class="waiting-screen">
    <text class="waiting-text">ç­‰å¾…æ¸¸æˆå¼€å§‹...</text>
  </view>
</view>
