<!--pages/replay/detail/detail.wxml-->
<view class="container" wx:if="{{gameRecord}}">
  <!-- æ¸¸æˆä¿¡æ¯ -->
  <view class="card">
    <view class="title">æ¸¸æˆä¿¡æ¯</view>
    <view class="game-info">
      <text>æ—¶é—´: {{gameRecord.timestamp}}</text>
      <text wx:if="{{isMultiplayer}}">æˆ¿é—´: {{gameRecord.roomId}}</text>
      <text>ç©å®¶æ•°: {{isMultiplayer ? gameRecord.players.length : gameRecord.gameState.players.length}}</text>
      <text>æœ€ç»ˆåº•æ± : {{isMultiplayer ? (currentReplayState ? currentReplayState.pot : gameRecord.finalResult.pot) : gameRecord.gameState.pot}}</text>
      <text wx:if="{{gameRecord.finalResult}}">ç»“æœ: {{gameRecord.finalResult.message}}</text>
    </view>
  </view>

  <!-- å¤šäººå¯¹å±€å›æ”¾çŠ¶æ€ -->
  <view class="card" wx:if="{{isMultiplayer && currentReplayState}}">
    <view class="title">å½“å‰çŠ¶æ€</view>
    <view class="replay-state">
      <text>é˜¶æ®µ: {{currentReplayState.phase}}</text>
      <text>åº•æ± : {{currentReplayState.pot}}</text>
      <text>å½“å‰ä¸‹æ³¨: {{currentReplayState.currentBet}}</text>
      <view class="community-cards" wx:if="{{currentReplayState.communityCards.length > 0}}">
        <text>å…¬å…±ç‰Œ:</text>
        <view class="cards">
          <view class="card-item" wx:for="{{currentReplayState.communityCards}}" wx:key="index">
            {{item.rank}}{{item.suit}}
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- å›æ”¾æ§åˆ¶ -->
  <view class="card">
    <view class="title">ç‰Œå±€å›æ”¾</view>
    <view class="replay-controls">
      <button class="btn btn-primary" bindtap="startReplay" wx:if="{{!isReplaying}}">å¼€å§‹å›æ”¾</button>
      <button class="btn btn-danger" bindtap="stopReplay" wx:else>åœæ­¢å›æ”¾</button>
      <text class="replay-progress">æ­¥éª¤: {{currentStep}} / {{isMultiplayer ? replaySteps.length : gameRecord.gameState.actions.length}}</text>
    </view>
    
    <!-- åŠ¨ä½œåˆ—è¡¨ -->
    <view class="actions-list">
      <!-- å¤šäººå¯¹å±€å›æ”¾æ­¥éª¤ -->
      <view 
        wx:if="{{isMultiplayer}}"
        class="action-item {{currentStep > item.step ? 'past' : ''}} {{currentStep === item.step ? 'current' : ''}}"
        wx:for="{{replaySteps}}" 
        wx:key="step"
        data-step="{{item.step}}"
        bindtap="jumpToStep"
      >
        <view class="action-header">
          <text class="action-description">{{item.description}}</text>
          <text class="action-phase">{{item.phase}}</text>
        </view>
        <view class="action-content" wx:if="{{item.action}}">
          <text class="action-type">{{item.action.action}}</text>
          <text wx:if="{{item.action.amount}}">é‡‘é¢: {{item.action.amount}}</text>
        </view>
      </view>
      
      <!-- å•äººæ¸¸æˆå›æ”¾ -->
      <view 
        wx:else
        class="action-item {{currentStep > index ? 'past' : ''}} {{currentStep === index + 1 ? 'current' : ''}}"
        wx:for="{{gameRecord.gameState.actions}}" 
        wx:key="index"
        data-step="{{index + 1}}"
        bindtap="jumpToStep"
      >
        <view class="action-header">
          <text class="action-player">ç©å®¶{{item.playerIndex + 1}}</text>
          <text class="action-phase">{{item.phase}}</text>
        </view>
        <view class="action-content">
          <text class="action-type">{{item.action}}</text>
          <text wx:if="{{item.amount}}">é‡‘é¢: {{item.amount}}</text>
        </view>
      </view>
    </view>
  </view>

  <!-- GTOåˆ†æ -->
  <view class="card" wx:if="{{gtoAnalysis}}">
    <view class="title">GTOåˆ†æ</view>
    <view class="analysis-summary">
      <view class="summary-item">
        <text class="summary-label">æ€»å†³ç­–æ•°:</text>
        <text class="summary-value">{{gtoAnalysis.totalDecisions}}</text>
      </view>
      <view class="summary-item">
        <text class="summary-label">æ­£ç¡®å†³ç­–:</text>
        <text class="summary-value">{{gtoAnalysis.correctDecisions}}</text>
      </view>
      <view class="summary-item">
        <text class="summary-label">å‡†ç¡®ç‡:</text>
        <text class="summary-value">{{gtoAnalysis.accuracy}}%</text>
      </view>
    </view>
    
    <button class="btn btn-secondary" bindtap="showAnalysis">æŸ¥çœ‹è¯¦ç»†åˆ†æ</button>
  </view>

  <!-- åˆ†äº«åŠŸèƒ½ -->
  <view class="card share-section">
    <view class="title">åˆ†äº«å¯¹å±€</view>
    <view class="share-buttons">
      <button class="btn btn-share" open-type="share">
        <text class="share-icon">ğŸ“¤</text>
        <text>åˆ†äº«åˆ°å¾®ä¿¡</text>
      </button>
      <button class="btn btn-share" bindtap="onCopyShareLink">
        <text class="share-icon">ğŸ”—</text>
        <text>å¤åˆ¶é“¾æ¥</text>
      </button>
      <button class="btn btn-share" bindtap="generateShareImage">
        <text class="share-icon">ğŸ–¼ï¸</text>
        <text>ç”Ÿæˆå›¾ç‰‡</text>
      </button>
    </view>
  </view>

  <!-- éšè—çš„canvasç”¨äºç”Ÿæˆåˆ†äº«å›¾ç‰‡ -->
  <canvas 
    canvas-id="shareCanvas" 
    style="position: fixed; top: -9999px; width: 750rpx; height: 1334rpx;"
  ></canvas>

  <!-- è¯¦ç»†åˆ†æå¼¹çª— -->
  <view wx:if="{{showAnalysis && gtoAnalysis}}" class="analysis-modal" bindtap="hideAnalysis">
    <view class="analysis-content" catchtap="stopPropagation">
      <view class="analysis-header">
        <text class="title">è¯¦ç»†åˆ†æ</text>
        <text class="close-btn" bindtap="hideAnalysis">Ã—</text>
      </view>
      
      <view class="mistakes-list" wx:if="{{gtoAnalysis.mistakes.length > 0}}">
        <view class="mistake-item" wx:for="{{gtoAnalysis.mistakes}}" wx:key="step">
          <view class="mistake-header">
            <text>æ­¥éª¤ {{item.step + 1}} - {{item.action.phase}}</text>
          </view>
      <view class="mistake-content">
        <text>ä½ çš„å†³ç­–: {{item.action.action}}</text>
        <text>GTOå»ºè®®: {{item.gtoAdvice.recommendedAction}}</text>
        <text>æœŸæœ›ä»·å€¼: {{item.gtoAdvice.ev}}</text>
        <view wx:if="{{item.gtoAdvice.frequencies}}" class="frequencies">
          <text>åŠ¨ä½œé¢‘ç‡: å¼ƒç‰Œ{{item.gtoAdvice.frequencies.fold}}% / è·Ÿæ³¨{{item.gtoAdvice.frequencies.call}}% / åŠ æ³¨{{item.gtoAdvice.frequencies.raise}}%</text>
        </view>
      </view>
        </view>
      </view>
      
      <view wx:else class="no-mistakes">
        <text>å¤ªæ£’äº†ï¼æ‰€æœ‰å†³ç­–éƒ½ç¬¦åˆGTOå»ºè®®ï¼</text>
      </view>
    </view>
  </view>
</view>
